name: Deploy SIPEG to Rumahweb

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      - name: Install composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Build assets (Vite)
        run: |
          npm ci
          npm run build
        env:
          CI: false

      - name: Create post-deploy script
        run: |
          cat > post-deploy.php << 'EOF'
          <?php
          // Auto-generated post-deploy script
          $password = '${{ secrets.DEPLOY_KEY }}';
          if (!isset($_GET['key']) || $_GET['key'] !== $password) {
              http_response_code(403);
              die('Forbidden');
          }

          require __DIR__.'/vendor/autoload.php';
          $app = require_once __DIR__.'/bootstrap/app.php';
          $kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);

          header('Content-Type: text/plain');
          echo "üîÑ Post-Deploy Cache Clear\n";
          echo str_repeat("=", 40) . "\n\n";

          try {
              $kernel->call('config:clear');
              echo "‚úÖ Config cleared\n";

              $kernel->call('cache:clear');
              echo "‚úÖ Cache cleared\n";

              $kernel->call('view:clear');
              echo "‚úÖ Views cleared\n";

              $kernel->call('route:clear');
              echo "‚úÖ Routes cleared\n";

              // Clear bootstrap cache
              foreach (glob(__DIR__.'/bootstrap/cache/*.php') as $file) {
                  if (basename($file) !== '.gitignore') {
                      @unlink($file);
                  }
              }
              echo "‚úÖ Bootstrap cache cleared\n";

              // Rebuild optimized cache
              $kernel->call('config:cache');
              echo "‚úÖ Config cached\n";

              $kernel->call('route:cache');
              echo "‚úÖ Routes cached\n";

              echo "\n‚ú® Deployment successful!\n";

              // Auto-delete this file after execution
              @unlink(__FILE__);
              echo "üóëÔ∏è  Self-deleted\n";

          } catch (Exception $e) {
              http_response_code(500);
              echo "‚ùå Error: " . $e->getMessage() . "\n";
          }
          EOF

      - name: Cleanup before deploy
        run: |
          rm -rf node_modules
          rm -rf .git
          rm -rf tests
          rm -rf .github

      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: ftp
          local-dir: "./"
          server-dir: ${{ secrets.FTP_PATH }}
          timeout: 600000
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/.env
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/logs/**

      - name: Trigger post-deploy cache clear
        run: |
          echo "‚è≥ Waiting for files to sync..."
          sleep 10

          echo "üîÑ Clearing cache on server..."
          curl -f -m 60 "https://sipeg.harikenangan.my.id/post-deploy.php?key=${{ secrets.DEPLOY_KEY }}" || echo "‚ö†Ô∏è Cache clear failed, but deployment completed"

          echo "‚úÖ Deployment completed!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ SIPEG deployed successfully!"
            echo "üåê URL: https://sipeg.harikenangan.my.id"
          else
            echo "‚ùå Deployment failed!"
          fi
