name: CI + Deploy SIPEG

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  PHP_VERSION: '8.4'

# =====================================================
# JOB 1 ‚Äì LINT (Laravel Pint)
# =====================================================
jobs:
  lint:
    name: Lint (Pint)
    runs-on: ubuntu-latest
    environment: Testing

    steps:
      - uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Add Flux Credentials Loaded From ENV
        run: composer config http-basic.composer.fluxui.dev "${{ secrets.FLUX_USERNAME }}" "${{ secrets.FLUX_LICENSE_KEY }}"

      - name: Install Dependencies
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
          npm install

      - name: Run Pint
        run: vendor/bin/pint

# =====================================================
# JOB 2 ‚Äì TESTS (Pest)  ‚Üí tidak blokir deploy
# =====================================================
  tests:
    name: Tests (Pest)
    runs-on: ubuntu-latest
    environment: Testing
    needs: lint
    continue-on-error: true   # kalau gagal, deploy tetap jalan

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: xdebug

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Node Dependencies
        run: npm i

      - name: Add Flux Credentials Loaded From ENV
        run: composer config http-basic.composer.fluxui.dev "${{ secrets.FLUX_USERNAME }}" "${{ secrets.FLUX_LICENSE_KEY }}"

      - name: Install Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Build Assets
        run: npm run build

      - name: Run Tests
        run: ./vendor/bin/pest

# =====================================================
# FUNGSI BANTU: STEP POST-DEPLOY (DIPAKAI DI SEMUA ATTEMPT)
# =====================================================
  deploy:
    name: Deploy to Rumahweb (attempt 1)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: lint
    # hanya jalan kalau PUSH ke main (bukan PR)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      - name: Install composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Build assets (Vite)
        run: |
          npm ci
          npm run build
        env:
          CI: false

      - name: Create post-deploy script
        run: |
          cat > post-deploy.php << 'EOF'
          <?php
          $password = '${{ secrets.DEPLOY_KEY }}';
          if (!isset($_GET['key']) || $_GET['key'] !== $password) {
              http_response_code(403);
              die('Forbidden');
          }

          require __DIR__.'/vendor/autoload.php';
          $app = require_once __DIR__.'/bootstrap/app.php';
          $kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);

          header('Content-Type: text/plain');
          echo "üîÑ Post-Deploy Cache Clear\n";
          echo str_repeat("=", 40) . "\n\n";

          try {
              $kernel->call('config:clear');
              echo "‚úÖ Config cleared\n";

              $kernel->call('cache:clear');
              echo "‚úÖ Cache cleared\n";

              $kernel->call('view:clear');
              echo "‚úÖ Views cleared\n";

              $kernel->call('route:clear');
              echo "‚úÖ Routes cleared\n";

              foreach (glob(__DIR__.'/bootstrap/cache/*.php') as $file) {
                  if (basename($file) !== '.gitignore') {
                      @unlink($file);
                  }
              }
              echo "‚úÖ Bootstrap cache cleared\n";

              $kernel->call('config:cache');
              echo "‚úÖ Config cached\n";

              $kernel->call('route:cache');
              echo "‚úÖ Routes cached\n";

              echo "\n‚ú® Deployment successful!\n";

              @unlink(__FILE__);
              echo "üóëÔ∏è  Self-deleted\n";

          } catch (Exception $e) {
              http_response_code(500);
              echo "‚ùå Error: " . $e->getMessage() . "\n";
          }
          EOF

      - name: Cleanup before deploy
        run: |
          rm -rf node_modules
          rm -rf .git
          rm -rf tests
          rm -rf .github

      - name: SFTP Deploy (attempt 1)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}   # isi 22 di Secrets kalau pakai SFTP
          protocol: sftp                  # ‚Üê pakai SFTP biar stabil
          local-dir: "./"
          server-dir: ${{ secrets.FTP_PATH }}
          timeout: 120000                 # 120 detik per operasi
          passive: true
          security: loose
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/.env
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/logs/**

      - name: Trigger post-deploy cache clear
        run: |
          echo "‚è≥ Waiting for files to sync..."
          sleep 10
          echo "üîÑ Clearing cache on server..."
          curl -f -m 60 "https://sipeg.harikenangan.my.id/post-deploy.php?key=${{ secrets.DEPLOY_KEY }}" || echo "‚ö†Ô∏è Cache clear failed, but deployment completed"
          echo "‚úÖ Deployment completed! (attempt 1)"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == 'success' ]; then
            echo "‚úÖ SIPEG deployed successfully! (attempt 1)"
          else
            echo "‚ùå Deployment failed on attempt 1!"
          fi

# =====================================================
# JOB 4 ‚Äì DEPLOY RETRY (attempt 2, auto)
# =====================================================
  deploy_retry_2:
    name: Deploy to Rumahweb (attempt 2 - auto retry)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: deploy
    if: needs.deploy.result == 'failure' && github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      - name: Install composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Build assets (Vite)
        run: |
          npm ci
          npm run build
        env:
          CI: false

      - name: Create post-deploy script
        run: |
          cat > post-deploy.php << 'EOF'
          <?php
          $password = '${{ secrets.DEPLOY_KEY }}';
          if (!isset($_GET['key']) || $_GET['key'] !== $password) {
              http_response_code(403);
              die('Forbidden');
          }
          require __DIR__.'/vendor/autoload.php';
          $app = require_once __DIR__.'/bootstrap/app.php';
          $kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
          header('Content-Type: text/plain');
          echo "üîÑ Post-Deploy Cache Clear\n";
          echo str_repeat("=", 40) . "\n\n";
          try {
              $kernel->call('config:clear');
              echo "‚úÖ Config cleared\n";
              $kernel->call('cache:clear');
              echo "‚úÖ Cache cleared\n";
              $kernel->call('view:clear');
              echo "‚úÖ Views cleared\n";
              $kernel->call('route:clear');
              echo "‚úÖ Routes cleared\n";
              foreach (glob(__DIR__.'/bootstrap/cache/*.php') as $file) {
                  if (basename($file) !== '.gitignore') {
                      @unlink($file);
                  }
              }
              echo "‚úÖ Bootstrap cache cleared\n";
              $kernel->call('config:cache');
              echo "‚úÖ Config cached\n";
              $kernel->call('route:cache');
              echo "‚úÖ Routes cached\n";
              echo "\n‚ú® Deployment successful!\n";
              @unlink(__FILE__);
              echo "üóëÔ∏è  Self-deleted\n";
          } catch (Exception $e) {
              http_response_code(500);
              echo "‚ùå Error: " . $e->getMessage() . "\n";
          }
          EOF

      - name: Cleanup before deploy
        run: |
          rm -rf node_modules
          rm -rf .git
          rm -rf tests
          rm -rf .github

      - name: SFTP Deploy (attempt 2)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: sftp
          local-dir: "./"
          server-dir: ${{ secrets.FTP_PATH }}
          timeout: 120000
          passive: true
          security: loose
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/.env
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/logs/**

      - name: Trigger post-deploy cache clear
        run: |
          echo "‚è≥ Waiting for files to sync..."
          sleep 10
          echo "üîÑ Clearing cache on server (retry 2)..."
          curl -f -m 60 "https://sipeg.harikenangan.my.id/post-deploy.php?key=${{ secrets.DEPLOY_KEY }}" || echo "‚ö†Ô∏è Cache clear failed, but deployment completed"
          echo "‚úÖ Deployment completed! (attempt 2)"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == 'success' ]; then
            echo "‚úÖ SIPEG deployed successfully! (attempt 2)"
          else
            echo "‚ùå Deployment failed on attempt 2!"
          fi

# =====================================================
# JOB 5 ‚Äì DEPLOY RETRY (attempt 3, auto)
# =====================================================
  deploy_retry_3:
    name: Deploy to Rumahweb (attempt 3 - auto retry)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: deploy_retry_2
    if: needs.deploy_retry_2.result == 'failure' && github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      - name: Install composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Build assets (Vite)
        run: |
          npm ci
          npm run build
        env:
          CI: false

      - name: Create post-deploy script
        run: |
          cat > post-deploy.php << 'EOF'
          <?php
          $password = '${{ secrets.DEPLOY_KEY }}';
          if (!isset($_GET['key']) || $_GET['key'] !== $password) {
              http_response_code(403);
              die('Forbidden');
          }
          require __DIR__.'/vendor/autoload.php';
          $app = require_once __DIR__.'/bootstrap/app.php';
          $kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
          header('Content-Type: text/plain');
          echo "üîÑ Post-Deploy Cache Clear\n";
          echo str_repeat("=", 40) . "\n\n";
          try {
              $kernel->call('config:clear');
              echo "‚úÖ Config cleared\n";
              $kernel->call('cache:clear');
              echo "‚úÖ Cache cleared\n";
              $kernel->call('view:clear');
              echo "‚úÖ Views cleared\n";
              $kernel->call('route:clear');
              echo "‚úÖ Routes cleared\n";
              foreach (glob(__DIR__.'/bootstrap/cache/*.php') as $file) {
                  if (basename($file) !== '.gitignore') {
                      @unlink($file);
                  }
              }
              echo "‚úÖ Bootstrap cache cleared\n";
              $kernel->call('config:cache');
              echo "‚úÖ Config cached\n";
              $kernel->call('route:cache');
              echo "‚úÖ Routes cached\n";
              echo "\n‚ú® Deployment successful!\n";
              @unlink(__FILE__);
              echo "üóëÔ∏è  Self-deleted\n";
          } catch (Exception $e) {
              http_response_code(500);
              echo "‚ùå Error: " . $e->getMessage() . "\n";
          }
          EOF

      - name: Cleanup before deploy
        run: |
          rm -rf node_modules
          rm -rf .git
          rm -rf tests
          rm -rf .github

      - name: SFTP Deploy (attempt 3)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: sftp
          local-dir: "./"
          server-dir: ${{ secrets.FTP_PATH }}
          timeout: 120000
          passive: true
          security: loose
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/.env
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/logs/**

      - name: Trigger post-deploy cache clear
        run: |
          echo "‚è≥ Waiting for files to sync..."
          sleep 10
          echo "üîÑ Clearing cache on server (retry 3)..."
          curl -f -m 60 "https://sipeg.harikenangan.my.id/post-deploy.php?key=${{ secrets.DEPLOY_KEY }}" || echo "‚ö†Ô∏è Cache clear failed, but deployment completed"
          echo "‚úÖ Deployment completed! (attempt 3)"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == 'success' ]; then
            echo "‚úÖ SIPEG deployed successfully! (attempt 3)"
          else
            echo "‚ùå Deployment failed even after 3 attempts!"
          fi
